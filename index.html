<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extrator de N√∫meros PRO</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px; 
      max-width: 800px; 
      margin: 0 auto;
      background: #f7f7f7;
      color: #333;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2, h3 { text-align: center; margin-bottom: 20px; }
    .input-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      text-align: center;
      transition: border-color 0.3s;
    }
    .input-section:hover { border-color: #007bff; }
    .paste-area {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 40px 20px;
      margin: 20px 0;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .paste-area:hover { background: #e9ecef; border-color: #007bff; }
    img, canvas {
      max-width: 100%;
      max-height: 400px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
      display: none;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #0056b3);
      width: 0%;
      transition: width 0.3s;
      border-radius: 10px;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    .char-counter {
        text-align: right;
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        padding-right: 5px;
        font-weight: bold;
    }
    .char-counter.valid {
        color: #28a745;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    .status.processing { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .buttons {
      margin-top: 15px;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    button.secondary {
        background-color: #6c757d;
    }
    button.secondary:hover {
        background-color: #5a6268;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #cccccc; color: #666; cursor: not-allowed; }
    
    .useful-links {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        text-align: center;
    }
    .link-button {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      text-decoration: none;
      margin: 5px;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .link-button:hover {
        background: #218838;
    }

    .history { margin-top: 30px; }
    .history-item {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .history-item:hover { background: #e0e0e0; }
    .history-item .date { font-weight: bold; color: #555; }
    .history-item .content {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'Courier New', monospace;
    }
    footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      font-size: 14px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üî¢ Extrator de N√∫meros PRO</h2>
    
    <!-- Se√ß√£o de input simplificada -->
    <div class="input-section">
      <h3>üìã Colar Imagem</h3>
      <div class="paste-area" id="pasteArea">
        <p><strong>Clique aqui e cole uma imagem (Ctrl+V)</strong></p>
      </div>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    
    <canvas id="preview" style="display: none;"></canvas>
    
    <h3>üìä N√∫meros extra√≠dos:</h3>
    <textarea id="output" placeholder="Os n√∫meros extra√≠dos aparecer√£o aqui..."></textarea>
    <div id="charCounter" class="char-counter">D√≠gitos: 0 | Linhas: 0</div>
    
    <div class="buttons">
      <button onclick="removeSpecialChars()" id="removeCharsBtn" class="secondary" disabled>#Ô∏è‚É£ Apenas D√≠gitos</button>
      <button onclick="handleCopyButtonClick()" id="copyBtn" disabled>üìã Copiar</button>
      <button onclick="clearAll()" id="clearBtn">üóëÔ∏è Limpar</button>
    </div>

    <div class="useful-links">
        <h3>üîó Links √öteis de Consulta</h3>
        <a href="https://solucoes.receita.fazenda.gov.br/Servicos/cnpjreva/Cnpjreva_Solicitacao.asp" onclick="searchCnpj(event)" target="_blank" rel="noopener noreferrer" class="link-button">CNPJ</a>
        <a href="https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATB/ConsultaOptantes.app/ConsultarOpcao.aspx" onclick="searchCnpj(event)" target="_blank" rel="noopener noreferrer" class="link-button">Simples Nacional</a>
        <a href="https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx" onclick="searchNfe(event)" target="_blank" rel="noopener noreferrer" class="link-button">Nota Fiscal (NFe)</a>
    </div>
    
    <div class="history">
      <h3>üìú Hist√≥rico (√∫ltimas 5 extra√ß√µes)</h3>
      <div id="historyContainer"></div>
    </div>

    <footer>
      <p id="signature"></p>
    </footer>

  </div>

  <script>
    // A constante 'imageInput' foi removida
    const output = document.getElementById('output');
    const preview = document.getElementById('preview');
    const pasteArea = document.getElementById('pasteArea');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const status = document.getElementById('status');
    const copyBtn = document.getElementById('copyBtn');
    const removeCharsBtn = document.getElementById('removeCharsBtn');
    const historyContainer = document.getElementById('historyContainer');
    const charCounter = document.getElementById('charCounter');
    const signature = document.getElementById('signature');

    let processingQueue = [];
    let isProcessing = false;

    function updateCharCounter() {
        const text = output.value;
        const digitCount = (text.match(/\d/g) || []).length;
        const lineCount = text.split('\n').filter(line => line.trim() !== '').length;
        charCounter.textContent = `D√≠gitos: ${digitCount} | Linhas: ${lineCount}`;
        if (digitCount === 14 || digitCount === 44) {
            charCounter.classList.add('valid');
        } else {
            charCounter.classList.remove('valid');
        }
    }

    output.addEventListener('input', updateCharCounter);

    function showStatus(message, type = 'processing') {
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
    }
    function hideStatus() { status.style.display = 'none'; }
    function updateProgress(percentage) {
      progressFill.style.width = percentage + '%';
      progressBar.style.display = percentage > 0 ? 'block' : 'none';
    }

    async function preprocessImage(imageSource) {
        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                const canvas = preview;
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.filter = 'grayscale(1) contrast(1.5)';
                ctx.drawImage(img, 0, 0);
                canvas.style.display = 'block';
                resolve(canvas.toDataURL('image/png'));
            };
            img.src = imageSource;
        });
    }

    async function processQueue() {
        if (isProcessing || processingQueue.length === 0) return;
        isProcessing = true;
        
        const file = processingQueue.shift();
        showStatus(`A processar imagem...`, 'processing');
        
        const imageURL = URL.createObjectURL(file);
        const preprocessedImage = await preprocessImage(imageURL);

        try {
            const worker = await Tesseract.createWorker({
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const progress = Math.round(m.progress * 100);
                        updateProgress(progress);
                        showStatus(`üîç A reconhecer... ${progress}%`, 'processing');
                    }
                }
            });
            await worker.loadLanguage('por');
            await worker.initialize('por');
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789.,-%'
            });

            const { data } = await worker.recognize(preprocessedImage);
            await worker.terminate();

            const textContent = data.text;
            const numerosRegex = /[-+]?\d+(?:[.,]\d+)*(?:\s*%)?/g;
            const numeros = textContent.match(numerosRegex);

            if (numeros && numeros.length > 0) {
                const numerosLimpos = [...new Set(numeros)].map(n => n.trim()).filter(Boolean);
                const currentOutput = output.value;
                output.value = (currentOutput ? currentOutput + '\n' : '') + numerosLimpos.join('\n');
                updateCharCounter();
                showStatus(`‚úÖ ${numerosLimpos.length} n√∫meros adicionados!`, 'success');
                copyBtn.disabled = false;
                removeCharsBtn.disabled = false;
            } else {
                 showStatus('‚ö†Ô∏è Nenhum n√∫mero encontrado neste ficheiro.', 'error');
            }

        } catch (error) {
            console.error('Erro no OCR:', error);
            showStatus('‚ùå Erro ao processar imagem.', 'error');
        } finally {
            URL.revokeObjectURL(imageURL);
            isProcessing = false;
            updateProgress(0);
            if (processingQueue.length > 0) {
                processQueue();
            } else {
                saveToHistory(output.value);
                loadHistory();
                showStatus('üèÅ Processamento conclu√≠do!', 'success');
            }
        }
    }

    function handleFiles(files) {
        const imageFiles = [...files].filter(file => file.type.startsWith('image/'));
        if (imageFiles.length === 0) {
            showStatus('‚ùå Por favor, cole um ficheiro de imagem v√°lido', 'error');
            return;
        }
        processingQueue.push(...imageFiles);
        if (!isProcessing) {
            output.value = '';
            updateCharCounter();
            processQueue();
        }
    }

    // Event listener de 'change' foi removido
    
    document.addEventListener('paste', async (e) => {
        const items = e.clipboardData?.items;
        if (!items) return;
        const imageItem = [...items].find(item => item.type.startsWith('image/'));
        if (imageItem) {
            e.preventDefault();
            const file = imageItem.getAsFile();
            if (file) handleFiles([file]);
        }
    });

    // Event listeners de 'drag' e 'drop' foram removidos
    
    function removeSpecialChars() {
        const currentText = output.value;
        if (!currentText.trim()) return;
        const cleanedText = currentText.replace(/[^0-9\n]/g, ''); 
        output.value = cleanedText;
        updateCharCounter();
    }

    function copyToClipboard(textToCopy) {
        return new Promise((resolve, reject) => {
            navigator.clipboard.writeText(textToCopy).then(resolve).catch(err => {
                console.warn('Modern copy failed, trying fallback.', err);
                try {
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textToCopy;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    resolve();
                } catch (fallbackErr) {
                    console.error('Fallback copy failed.', fallbackErr);
                    reject(fallbackErr);
                }
            });
        });
    }

    async function handleCopyButtonClick() {
        if (!output.value.trim()) return;
        try {
            await copyToClipboard(output.value);
            copyBtn.textContent = '‚úÖ Copiado!';
            setTimeout(() => { copyBtn.textContent = 'üìã Copiar'; }, 2000);
        } catch (error) {
            showStatus('‚ùå Falha ao copiar o texto.', 'error');
        }
    }

    async function searchCnpj(event) {
        event.preventDefault();
        const allDigits = output.value.replace(/\D/g, '');
        const cnpjMatch = allDigits.match(/\d{14}/);
        
        if (cnpjMatch) {
            const cnpj = cnpjMatch[0];
            try {
                await copyToClipboard(cnpj);
                showStatus(`CNPJ ${cnpj} copiado! Cole no site que ser√° aberto.`, 'success');
                window.open(event.target.href, '_blank');
            } catch (error) {
                showStatus('‚ùå Falha ao copiar o CNPJ.', 'error');
            }
        } else {
            showStatus('Nenhum CNPJ de 14 d√≠gitos foi encontrado no texto.', 'error');
        }
    }

    async function searchNfe(event) {
        event.preventDefault();
        const allDigits = output.value.replace(/\D/g, '');
        const nfeMatch = allDigits.match(/\d{44}/);

        if (nfeMatch) {
            const nfe = nfeMatch[0];
            try {
                await copyToClipboard(nfe);
                showStatus(`Chave da NFe copiada! Cole no site que ser√° aberto.`, 'success');
                window.open(event.target.href, '_blank');
            } catch (error) {
                showStatus('‚ùå Falha ao copiar a chave da NFe.', 'error');
            }
        } else {
            showStatus('Nenhuma chave de NFe de 44 d√≠gitos foi encontrada no texto.', 'error');
        }
    }


    function clearAll() {
        output.value = '';
        preview.style.display = 'none';
        // A linha 'imageInput.value = ""' foi removida
        hideStatus();
        updateProgress(0);
        copyBtn.disabled = true;
        removeCharsBtn.disabled = true;
        updateCharCounter();
    }

    function saveToHistory(text) {
        if (!text.trim()) return;
        let history = JSON.parse(localStorage.getItem('ocrHistory') || '[]');
        history.unshift({ date: new Date().toLocaleString('pt-BR'), content: text });
        history = history.slice(0, 5);
        localStorage.setItem('ocrHistory', JSON.stringify(history));
    }

    function loadHistory() {
        let history = JSON.parse(localStorage.getItem('ocrHistory') || '[]');
        historyContainer.innerHTML = '';
        if (history.length === 0) {
            historyContainer.innerHTML = '<p>Nenhum hist√≥rico encontrado.</p>';
            return;
        }
        history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<div class="date">${item.date}</div><div class="content">${item.content.replace(/\n/g, ' | ')}</div>`;
            div.onclick = () => {
                output.value = item.content;
                copyBtn.disabled = false;
                removeCharsBtn.disabled = false;
                updateCharCounter();
            };
            historyContainer.appendChild(div);
        });
    }

    function setSignature() {
        const now = new Date();
        const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
        const formattedDate = now.toLocaleString('pt-BR', options);
        signature.textContent = `Feito por HAlexandre em ${formattedDate.replace(',', ' √†s')}`;
    }

    window.onload = () => {
        loadHistory();
        updateCharCounter();
        setSignature();
    };
  </script>
</body>
</html>
